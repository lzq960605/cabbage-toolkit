<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <!-- import CSS -->
  <link rel="stylesheet" href="element-ui/css/index.css">
  <!-- steamdeck scale 1280x800 -->
  <style type="text/css">
    .el-header {
      background-color: #B3C0D1;
      color: #333;
      text-align: center;
      line-height: 60px;
      max-width: 1080px;
    }
    .el-footer {
      /*background-color: #B3C0D1;*/
      /*color: #333;*/
      text-align: right;
      /*line-height: 12px;*/
    }

    .el-aside {
      /*background-color: #D3DCE6;*/
      color: #333;
      text-align: center;
      /*line-height: 580px;*/
    }

    .el-main {
      background-color: #E9EEF3;
      color: #333;
      text-align: center;
      max-width: 540px;
      /*line-height: 160px;*/
    }

    body > .el-container {
      margin-bottom: 40px;
      min-height: 580px;
    }

    /*.el-container:nth-child(5) .el-aside,*/
    /*.el-container:nth-child(6) .el-aside {*/
      /*line-height: 260px;*/
    /*}*/

    /*.el-container:nth-child(7) .el-aside {*/
      /*line-height: 320px;*/
    /*}*/


    .text {
      font-size: 14px;
    }

    .item {
      /*margin-bottom: 18px;*/

    }

    .clearfix:before,
    .clearfix:after {
      display: table;
      content: "";
    }
    .clearfix:after {
      clear: both
    }

    .box-card {
      max-width: 480px;
    }

    .el-button {
      margin-bottom: 12px;
    }
  </style>
</head>
<body>
  <div id="app" style="background-color: #E9EEF3">


    <el-container>
      <el-header  style="display: flex;justify-content: space-between;  font-size: 12px">
          <div style="width: 30%;text-align: left">
              <span style="font-size: 18px;font-weight: bolder">大白菜工具箱{{ appSetting.version }}</span>
              &nbsp;&nbsp;&nbsp;<a href="#" @click="onEnterAuthorHomeSite" style="color: #6e3ac2">作者B站点首页</a>
          </div>
          <div style="width: 70%;text-align: right;">
              <span>请选择:</span>
              <el-select @change="onChangeWindows" v-model="main_windows" placeholder="请选择">
                  <el-option
                          v-for="item in options"
                          :key="item.value"
                          :label="item.label"
                          :value="item.value">
                  </el-option>
              </el-select>
          </div>

      </el-header>
      <el-container  v-if="main_windows=='1'">
        <el-aside width="200px" style="height:580px;width: 220px">
          <el-menu :default-openeds="['1']">
            <el-submenu index="1">
              <template slot="title"><i class="el-icon-arrow-down"></i>Proton游戏列表</template>

              <el-menu-item  v-for="(item,index) in gameList" @click="onClickGameItem(item)" :index="(index+1).toString()" class="text item" style="padding-left: 0px;">
                {{item.name}}
              </el-menu-item >

            </el-submenu>
          </el-menu>
        </el-aside>
        <el-main>
          <div style="text-align: left">
            <p> {{!currentGame.id ? '未选择游戏':currentGame.name}}</p>
          </div>
          <el-divider></el-divider>
          <el-card class="box-card" style="text-align: left">
            <div slot="header" class="clearfix">
              <span>打补丁功能</span>
              <!--<el-button type="success" plain style="float: right; padding: 3px 0" type="text">操作按钮</el-button>-->
            </div>

            <el-row>
              <el-button type="success" plain @click="onRunWindowsApp('exe')">选择exe并运行</el-button>
              <el-button type="success" plain @click="onRunWindowsApp('bat')">选择bat并运行</el-button>
              <el-button type="success" plain @click="onShowStorageChoice('openDiskC_Path')" >打开C盘位置</el-button>
              <el-button v-if="currentGame.nonSteam=='0'" type="success" plain @click="onShowStorageChoice('openGameInstallPath')" >打开游戏安装目录</el-button>
            </el-row>
          </el-card>

          <el-divider></el-divider>
          <el-card class="box-card" style="text-align: left">
            <div slot="header" class="clearfix">
              <span>windows功能</span>
              <!--<el-button type="success" plain style="float: right; padding: 3px 0" type="text">操作按钮</el-button>-->
            </div>
            <el-row>
              <el-button type="success" plain @click="onHelperGeneralOpen('openTaskMgr')" >任务管理器</el-button>
              <el-button type="success" plain @click="onHelperGeneralOpen('openRegedit')" >注册表</el-button>
              <el-button type="success" plain @click="onHelperGeneralOpen('openWineCfg')" >wine设置</el-button>
              <el-button type="success" plain @click="onHelperGeneralOpen('openExplorer')" >浏览文件</el-button>
            </el-row>
          </el-card>
          <el-divider></el-divider>
          <div style="text-align: left;font-size: 10px;color: #777;">
            <p>Tips:</p>
            <p>1. 若有游戏没在游戏列表显示, 在steam客户端，点击游戏属性，强制设置GE-Proton兼容层，运行一下</p>
          </div>
        </el-main>

        <el-aside style="min-width: 320px;padding:20px;background-color: #E9EEF3">
          <p>游戏信息:</p>
          <el-divider></el-divider>
          <div style="text-align: left">
            <p>游戏id: {{currentGame.id}}</p>
            <p>游戏类型: {{currentGame.nonSteam ? '非Steam游戏' : 'Steam游戏'}}</p>
          </div>
        </el-aside>
      </el-container>

      <!-- 兼容层补丁 -->
      <el-container  v-if="main_windows=='2'">
        <el-aside width="200px" style="height:580px;width: 220px">
          <el-menu :default-openeds="['1']">

            <el-submenu index="1">
              <template slot="title"><i class="el-icon-arrow-down"></i>GE-Proton兼容层列表</template>
              <el-menu-item  v-for="(item,index) in geProtonList" @click="onClickGeProtonItem(item)" :index="(index+1).toString()" class="text item" style="padding-left: 0px;">
                {{item.name}}
              </el-menu-item >
            </el-submenu>

          </el-menu>
        </el-aside>
        <el-main>
          <div style="text-align: left">
            <p> {{!currentGeProton.name ? '未选择兼容层':currentGeProton.name}}</p>
          </div>
          <el-divider></el-divider>
          <el-card class="box-card" style="text-align: left">
            <div slot="header" class="clearfix">
              <span>多开exe补丁</span>
              <!--<el-button type="success" plain style="float: right; padding: 3px 0" type="text">操作按钮</el-button>-->
            </div>

            <el-row>
              <el-button type="success" plain @click="onGeProtonGeneralFunc('makeGeProtonPatch')">打补丁</el-button>
              <el-button type="success" plain @click="onGeProtonGeneralFunc('revertGeProtonPatch')">复原补丁</el-button>
            </el-row>
          </el-card>

          <el-divider></el-divider>
          <el-card class="box-card" style="text-align: left">
            <div slot="header" class="clearfix">
              <el-select @change="onChangeGeProtonGame"  v-model="geGameOptionValue" placeholder="请选择游戏">
                <el-option
                        v-for="item in geGameOptions"
                        :key="item.value"
                        :label="item.label"
                        :value="item.value">
                </el-option>
              </el-select>
              <span>游戏开启时同时启动:</span>
              <!--<el-button type="success" plain style="float: right; padding: 3px 0" type="text">操作按钮</el-button>-->
            </div>
            <el-row v-if="geGameOptionValue!=''">
              <el-button type="success" plain @click="updateGeProtonAttachGame">{{!!geGameOptionConf.WINE_EXTRA_EXE ? '编辑' : '添加'}}附加exe</el-button>
              <el-button type="success" plain @click="updateGeProtonTaskmgr">{{geGameOptionConf.WINE_TASKMGR == '1' ? '关闭' : '启动'}}任务管理器</el-button>
              <el-button type="success" plain @click="updateGeProtonCheat('CheatEngine')">{{geGameOptionConf.WINE_CHEATENGINE == '1' ? '关闭' : '启动'}}CE修改器</el-button>
              <el-button type="success" plain @click="updateGeProtonCheat('FLiNGTrainer')">{{geGameOptionConf.WINE_FLINGTRAINER == '1' ? '关闭' : '启动'}}风灵月影</el-button>
            </el-row>
          </el-card>

            <el-divider></el-divider>
            <div style="text-align: left;font-size: 10px;color: #777;">
                <p>Tips:</p>
                <p>1. 若有兼容层列表没显示, 请手动下载GE-Proton到.local/share/Steam/compatibilitytools.d下</p>
            </div>

        </el-main>

        <el-aside style="min-width: 320px;padding:20px;background-color: #E9EEF3">
          <p style="text-align: left;font-weight: bolder;">兼容层信息:</p>
          <el-divider></el-divider>
          <div style="text-align: left">
            <p>补丁版本: {{!!currentGeProton.version ? currentGeProton.version : '未打补丁'}}</p>
            <p>存储位置: {{currentGeProton.path}}</p>
          </div>
          <div v-if="geGameOptionValue!=''">
            <br/>
            <p style="text-align: left;font-weight: bolder;">游戏设置状态:</p>
            <el-divider></el-divider>
            <div style="text-align: left">
              <p>游戏启动时打开任务管理器: {{geGameOptionConf.WINE_TASKMGR == '1' ? '是' : '否'}}</p>
              <p style="word-break:break-word">游戏启动时打开以下程序: {{geGameOptionConf.WINE_EXTRA_EXE ? geGameOptionConf.WINE_EXTRA_EXE : ''}}</p>
              <p>游戏启动时打开CE修改器: {{geGameOptionConf.WINE_CHEATENGINE == '1' ? '是' : '否'}}</p>
              <p>游戏启动时打开风灵月影: {{geGameOptionConf.WINE_FLINGTRAINER == '1' ? '是' : '否'}}</p>
            </div>
          </div>
        </el-aside>
      </el-container>

      <el-container  v-if="main_windows=='3'">
          <div style="display: flex; flex-direction: column">
              <!-- type="border-card"  -->
             <el-tabs tab-position="left" style="width: 100%">
              <el-tab-pane label="系统工具">
                  <!--列表-->
                  <el-table size="small" :data="appSetting.necessary_tools" highlight-current-row border >
                      <el-table-column sortable prop="deptName" label="软件图标" align="center" min-width="120">
                          <template v-if="scope.row.icon"  width="70" slot-scope="scope">
                              <img   style="width:60px;height:60px;border:none;" :src="scope.row.icon">
                          </template>
                      </el-table-column>
                      <el-table-column sortable prop="editTime" label="简介" width="484">
                          <template slot-scope="scope">
                              <p>软件名称:{{ scope.row.name }}</p>
                              <p>简介:{{ scope.row.introduce }}</p>
                          </template>
                      </el-table-column>
                      <el-table-column align="center" label="操作" min-width="340">
                          <template slot-scope="scope">
                              <template v-if="scope.row.install_way=='ARCHIVE_DECOMPRESSION'">
                                  <el-button size="mini" type="danger" @click="onSystemToolsDownload(scope.$index, scope.row)">下载</el-button>
                                  <el-button size="mini" @click="onArchiveInstallFromDownloadPath(scope.$index, scope.row, 1)">从下载目录安装</el-button>
                                  <el-button size="mini"  @click="onSystemToolsShowPath(scope.$index, scope.row)">打开安装目录</el-button>
                              </template>
                              <template v-if="scope.row.install_way=='LINUX_SCRIPT'">
                                  <el-button size="mini" type="danger" @click="onSystemToolsInstall(scope.$index, scope.row)">安装</el-button>
                                  <el-button size="mini" @click="onSystemToolsStatus(scope.$index, scope.row)">软件状态</el-button>
                              </template>
                          </template>
                      </el-table-column>
                  </el-table>
              </el-tab-pane>
              <el-tab-pane label="windows软件">
                  <!--列表-->
                  <el-table size="small" :data="appSetting.windows_app" highlight-current-row border >
                      <el-table-column sortable prop="deptName" label="软件图标" align="center" min-width="120">
                          <template v-if="scope.row.icon"  width="70" slot-scope="scope">
                              <img   style="width:60px;height:60px;border:none;" :src="scope.row.icon">
                          </template>
                      </el-table-column>
                      <el-table-column sortable prop="editTime" label="简介" width="484">
                          <template slot-scope="scope">
                              <p>软件名称:{{ scope.row.name }}</p>
                              <p>简介:{{ scope.row.introduce }}</p>
                          </template>
                      </el-table-column>
                      <el-table-column align="center" label="操作" min-width="340">
                          <template slot-scope="scope">
                              <el-button size="mini" type="danger" @click="onSoftwareDownload(scope.$index, scope.row)">下载</el-button>
                              <el-button size="mini" @click="onArchiveInstallFromDownloadPath(scope.$index, scope.row)">从下载目录安装</el-button>
                              <el-button size="mini"  @click="onSoftwareShowPath(scope.$index, scope.row)">打开安装目录</el-button>
                          </template>
                      </el-table-column>
                  </el-table>
              </el-tab-pane>
          </el-tabs>
              <div style="text-align: left;font-size: 10px;color: #777;">
                  <p>Tips:</p>
                  <p>1. 下载的软件都要放置到用户下载目录(Downloads)下，不然无法扫描安装</p>
              </div>
          </div>

      </el-container>

      <el-footer></el-footer>
    </el-container>


    <!-- 兼容层补丁 -->



    <el-dialog
            title="提示"
            :visible.sync="storageDialogVisible"
            width="30%">
      <span>这个游戏是否安装在SD卡上?</span>
        <span slot="footer" class="dialog-footer">
        <el-button type="success" plain @click="onConfirmStorageChoice(false)">否</el-button>
        <el-button type="success" plain type="primary" @click="onConfirmStorageChoice(true)">是</el-button>
      </span>
    </el-dialog>

      <!-- 选择匹配的安装软件列表 -->
      <el-dialog title="选择要安装的软件" :visible.sync="softwareDialogVisible" width="30%">
          <el-form label-width="80px">
              <el-form-item label="选择软件" prop="gender">
                  <el-select v-model="softwareDialogOptionsValue" placeholder="请选择">
                      <el-option
                              v-for="item in softwareDialogOptions"
                              :key="item.value"
                              :label="item.label"
                              :value="item.value">
                      </el-option>
                  </el-select>
              </el-form-item>
          </el-form>
          <div slot="footer" class="dialog-footer">
              <el-button size="small">取消</el-button>
              <el-button size="small" type="primary"  class="title" @click="onConfirmInstallSoftware">安装</el-button>
          </div>
      </el-dialog>
  </div>
</body>
  <script src="axios/axios.min.js"></script>
  <!-- import Vue before Element -->
  <script src="vue/vue.js"></script>
  <!-- import JavaScript -->
  <script src="element-ui/js/index.js"></script>

  <script>
    const ARCHIVE_FILE_SUFFIX = [".tar", ".tar.xz", ".tar.gz", ".tar.gz", ".tar.bz2", ".tar.Z", ".tgz", ".zip"];
    const STEAM_CONST = {
      "STEAM_COMPAT_TOOL_PATH":".local/share/Steam/compatibilitytools.d",
      "STEAM_APPMANIFEST_PATH":".local/share/Steam/steamapps",
      "STEAM_APP_PATH":".local/share/Steam/steamapps/common",
      "STEAM_APP_COMPAT_PATH":".local/share/Steam/steamapps/compatdata",
      "STEAM_SDCARD_APP_PATH":"/run/media/mmcblk0p1/steamapps/common",
      "STEAM_SDCARD_APP_COMPAT_PATH":"/run/media/mmcblk0p1/steamapps/compatdata",
      "APP_WINDOWS_APP_PATH":".cabbage_toolkit/windows_app",
    };
    let fetch_async_task_ticker = null;
    function commandRequest(category, command, params, async_task) {
      return axios({
        method: 'post',
        url: '/api/cmd',
        data: {
          "category": category,
          "command": command,
          "params": params,
          "async_task": async_task || 0, // 是否异步任务
          "api_id": `${new Date().getTime()}`,
        }
      });
    }

    function apiErrorAndReturn(vue, resp) {
      if(resp.data.code !==0 || (resp.data.data && resp.data.data.hasOwnProperty('cmdCode') && resp.data.data.cmdCode !== 0)){
        const errMsg = (resp.data.data && resp.data.data.hasOwnProperty('errMsg')) ? resp.data.data.errMsg : resp.data.msg;
        vue.$message.error(errMsg);
        return true;
      }
      return false;
    }

    new Vue({
      el: '#app',
      data: function() {
        return {
          // main_windows: 'GAME_SETTING', // GAME_SETTING, PROTON_PATCH

          visible: false,

          options: [{
            value: '1',
            label: '游戏设置'
          }, {
            value: '2',
            label: '打兼容层补丁'
          }, {
              value: '3',
              label: '软件中心'
          }],
          main_windows: '1',  // 1: GAME_SETTING, 2: PROTON_PATCH

          gameList:[],
          currentGame: {
            id:'',
            name:'',
          },
          geProtonList:[],
          currentGeProton: {
            name:'',
            version:'',
            path:'',
          },

          storageDialogVisible: false,
          storageDialogTarget: '', // openDiskC_Path, openGameInstallPath

          softwareDialogVisible: false, //控制软件选择对话框显示与隐藏
          softwareDialogOptions: [],
          softwareDialogOptionsValue: '',
          softwareInfo: {},

          geGameOptions: [],
          geGameOptionValue: '',  // 游戏id
          // 兼容层游戏持久化配置
          geGameOptionConf: {
            WINE_TASKMGR:'',
            WINE_EXTRA_EXE:'',

            WINE_CHEATENGINE:'',
            WINE_FLINGTRAINER:'',
          },
          // app配置，优先从云端获取
          appSetting: {
              "version":"1.0.0",
              "adv": {
                  "author": "大白菜v50",
                  "author_home_page": "https://www.bilibili.com/video/BV17M411B7Ps/",
                  "helper_page": "https://www.bilibili.com/read/cv21084708/"
              },
              "helper_page": {
                  "install_ge_proton": "https://www.bilibili.com/read/cv21084708/",
                  "install_protontricks": "https://www.bilibili.com/video/cv21084708/"
              },
              "user_home_path": "/home/deck",
              "necessary_tools": [],
              "windows_app": [],
          },

          windowsAppListData: [],
        }
      },
      methods: {
        onHandlerAsyncTaskError: function(errArrays){
            const msg = errArrays.filter(v=>{
                return v.data.cmdCode != '0';
            }).map(v=>{
                return JSON.stringify(v.data.result).replace("\"", "");
            }).join("\n");
            if(msg.trim().length > 0){
                this.$message.success(msg);
            }
        },
        lockScreen: function(waitSecond){
            const loading = this.$loading({
                lock: true,
                text: '处理中',
                spinner: 'el-icon-loading',
                background: 'rgba(0, 0, 0, 0.7)'
            });
            setTimeout(() => {
                loading.close();
            }, waitSecond*1000);
        },
        onEnterAuthorHomeSite:function(){
            if(this.appSetting.adv.author_home_page){
                window.open(this.appSetting.adv.author_home_page);
            }
        },
        onGetAppSetting:function () {
            commandRequest('GAME_SETTING', 'getAppSetting', {}).then((resp)=>{
                if(apiErrorAndReturn(this, resp)){
                    return;
                }
                if(resp.data.data.result.length > 0){
                    this.appSetting = JSON.parse(resp.data.data.result);
                    console.log('onGetAppSetting: ' + JSON.stringify(this.appSetting));
                }
            }).catch((e)=>{
                console.error(e);
                this.$message.error(e.message);
            });
        },
        onClickGameItem:function (gameItem) {
            this.currentGame = JSON.parse(JSON.stringify(gameItem));
        },
        onClickGeProtonItem:function (item) {
          const currentGeProton = JSON.parse(JSON.stringify(item));
          currentGeProton.path = STEAM_CONST.STEAM_COMPAT_TOOL_PATH + "/" + item.name;
          this.currentGeProton = currentGeProton;
          this.onGeProtonVersion();

          this.geGameOptionValue = '';
        },
        updateAppToNewestVersion: function(){
            commandRequest('GAME_SETTING', 'updateAppToNewestVersion', {}).then((resp)=>{
                if(apiErrorAndReturn(this, resp)){
                    return;
                }
                // result:{need_update: 1, version: '1.0.0'}
                this.$message.success('升级完成, ');
                this.$alert(`升级完成，程序将自动关闭，请手动启动应用`, '提示', {
                    confirmButtonText: '确定',
                    callback: (action) => {
                        // 关闭python应用
                        axios({
                            method: 'get',
                            url: '/app/exit'
                        }).then(resp=>{
                            window.location.href="about:blank";
                            window.close();
                        });

                    }
                });
            }).catch((e)=>{
                console.error(e);
                this.$message.error(e.message);
            });
        },

        checkAppOnlineVersion: function(){
            commandRequest('GAME_SETTING', 'checkAppOnlineVersion', {}).then((resp)=>{
                if(apiErrorAndReturn(this, resp)){
                    return;
                }
                // result:{need_update: 1, version: '1.0.0'}
                if(resp.data.data.result.need_update == 1){
                    this.$alert(`检测到有新版本:${resp.data.data.result.version}, 是否现在升级?`, '提示', {
                        cancelButtonText: '取消',
                        confirmButtonText: '确定',
                        callback: (action) => {
                            if (action === 'confirm') {
                                this.$message.success('准备升级到'+ resp.data.data.result.version);
                                this.updateAppToNewestVersion();
                            }
                        }
                    });
                }

            }).catch((e)=>{
                console.error(e);
                this.$message.error(e.message);
            });
        },

        // 补丁功能
        onRunWindowsApp:function(appType){
          if(!this.currentGame.id){
            this.$message.warning('请先选择游戏');
            return;
          }
          // 先选择exe, 再打开
          commandRequest('GAME_SETTING', 'openFileSelector', {}).then((resp)=>{
            if(apiErrorAndReturn(this, resp)){
              return;
            }
            let path = resp.data.data.result;
            path = path.indexOf('select file:') >= 0 ? path.split('select file:')[1] : '';
            console.log(`path:${path}`);
            if(new RegExp("[\\u4E00-\\u9FFF]+", "g").test(path) || path.indexOf(' ') >= 0){
              this.$message.warning('文件路径或文件名不能包含中文或空格!');
              return;
            }
            if(path){
              const command = appType === 'exe' ? 'runExe' : 'runBat';
              this.lockScreen(4);
              commandRequest('GAME_SETTING', command, {
                targetPath: path,
                gameId: this.currentGame.id,
              }, 1).then((resp)=>{
                if(apiErrorAndReturn(this, resp)){
                  return;
                }
                this.$message.success('运行成功');
              }).catch((e)=>{
                console.error(e);
                this.$message.error(e.message);
              })
            }
          }).catch((e)=>{
            console.error(e);
            this.$message.error(e.message);
          });
        },

        // ------ 辅助功能 ------
        onHelperGeneralOpen:function(command){
          if(!this.currentGame.id){
            this.$message.warning('请先选择游戏');
            return;
          }
          this.lockScreen(4);
          commandRequest('GAME_SETTING', command, {
            gameId: this.currentGame.id,
          }, 1).then((resp)=>{
            if(apiErrorAndReturn(this, resp)){
              return;
            }
            this.$message.success('运行成功');
          }).catch((e)=>{
            console.error(e);
            this.$message.error(e.message);
          })
        },
        onShowStorageChoice:function(storageDialogTarget){
          console.log("this.storageDialogTarget = " + storageDialogTarget);
          if(!this.currentGame.id){
            this.$message.warning('请先选择游戏');
            return;
          }
          // 学习版游戏C盘仅仅会安装在内部存储上
          if(storageDialogTarget === 'openDiskC_Path' && this.currentGame.nonSteam === 1){
              this.onOpenDiskC_Path('INTERNAL_STORAGE');
              return;
          }
          this.storageDialogTarget = storageDialogTarget;
          this.storageDialogVisible = true;
        },
        onConfirmStorageChoice:function(choice){
          if(this.storageDialogTarget === 'openDiskC_Path'){
            this.onOpenDiskC_Path(choice ? 'SD_CARD' : 'INTERNAL_STORAGE');
          }
          else if(this.storageDialogTarget === 'openGameInstallPath'){
            this.onOpenGameInstallPath(choice ? 'SD_CARD' : 'INTERNAL_STORAGE');
          }
          this.storageDialogVisible = false;
        },
        // /run/media/mmcblk0p1/steamapps/compatdata/2426010261/pfx/drive_c
        onOpenDiskC_Path:function(storage){
          if(!this.currentGame.id){
            this.$message.warning('请先选择游戏');
            return;
          }
          this.lockScreen(2);
          commandRequest('GAME_SETTING', 'openDiskC_Path', {
            gameId: this.currentGame.id,
            storage:storage,
            targetPath: storage === 'INTERNAL_STORAGE' ?
                    `${STEAM_CONST.STEAM_APP_COMPAT_PATH}/${this.currentGame.id}/pfx/drive_c` :
                    `${STEAM_CONST.STEAM_SDCARD_APP_COMPAT_PATH}/${this.currentGame.id}/pfx/drive_c`
          }, 1).then((resp)=>{
            if(apiErrorAndReturn(this, resp)){
              return;
            }
            this.$message.success('运行成功');
          }).catch((e)=>{
            console.error(e);
            this.$message.error(e.message);
          })
        },
        onOpenGameInstallPath:function(storage){
          if(!this.currentGame.id){
            this.$message.warning('请先选择游戏');
            return;
          }
          this.lockScreen(2);
          commandRequest('GAME_SETTING', 'openGameInstallPath', {
            gameId: this.currentGame.id,
            storage:storage,
            targetPath: storage === 'INTERNAL_STORAGE' ?
                    `${STEAM_CONST.STEAM_APP_PATH}` :
                    `${STEAM_CONST.STEAM_SDCARD_APP_PATH}`
          }, 1).then((resp)=>{
            if(apiErrorAndReturn(this, resp)){
              return;
            }
            this.$message.success('运行成功');
          }).catch((e)=>{
            console.error(e);
            this.$message.error(e.message);
          })
        },
        onOpenTargetPath:function(path){
          this.lockScreen(2);
          commandRequest('GAME_SETTING', 'openTargetPath', {
              targetPath: path
          }, 1).then((resp)=>{
              if(apiErrorAndReturn(this, resp)){
                  return;
              }
              this.$message.success('运行成功');
          }).catch((e)=>{
              console.error(e);
              this.$message.error(e.message);
          })
        },

        onGeProtonGeneralFunc:function(command){
          if(!this.currentGeProton.name){
            this.$message.warning('请先选择兼容层');
            return;
          }
          commandRequest('PROTON_PATCH', command, {
            targetProton: this.currentGeProton.name
          }).then((resp)=>{
            if(apiErrorAndReturn(this, resp)){
              return;
            }
            // 最新补丁版本
            this.onGeProtonVersion();
            this.$message.success('运行成功');
          }).catch((e)=>{
            console.error(e);
            this.$message.error(e.message);
          })
        },

        onGeProtonVersion:function(){
          if(!this.currentGeProton.name){
            this.$message.warning('请先选择兼容层');
            return;
          }
          commandRequest('PROTON_PATCH', 'geProtonVersion', {
            targetProton: this.currentGeProton.name
          }).then((resp)=>{
            if(apiErrorAndReturn(this, resp)){
              return;
            }
            const result = resp.data.data.result.trim();
            const version =result.indexOf('version:') >= 0 ? result.substring(result.indexOf('version:') + 'version:'.length, result.indexOf(')')) : '';
            const currentGeProton = JSON.parse(JSON.stringify(this.currentGeProton));
            currentGeProton.version = version;
            this.currentGeProton = currentGeProton;
          }).catch((e)=>{
            console.error(e);
            this.$message.error(e.message);
          })
        },


        readGeProtonGameConf:function(){
          if(!this.currentGeProton.name){
            this.$message.warning('请先选择兼容层');
            return;
          }
          if(!this.geGameOptionValue){
            this.$message.warning('请先选择要设置的游戏');
            return;
          }

          commandRequest('PROTON_PATCH', 'readGeProtonGameConfToDict', {
            targetProton: this.currentGeProton.name,
            gameId: this.geGameOptionValue,
          }).then((resp)=>{
            if(apiErrorAndReturn(this, resp)){
              return;
            }
            if(!resp.data.data.result){
              this.geGameOptionConf = {
                WINE_TASKMGR: '0',
                WINE_EXTRA_EXE: '',
              };
              return;
            }
            this.geGameOptionConf = JSON.parse(JSON.stringify(resp.data.data.result))
          }).catch((e)=>{
            console.error(e);
            this.$message.error(e.message);
          })
        },

        writeGeProtonGameConfContent:function(json){
          if(!this.currentGeProton.name){
            this.$message.warning('请先选择兼容层');
            return;
          }
          if(!this.geGameOptionValue){
            this.$message.warning('请先选择要设置的游戏');
            return;
          }
          const content = Object.entries(json).map(v=>{
             return `${v[0]}=${v[1]}`;
          }).sort().join('\n');
          commandRequest('PROTON_PATCH', 'writeGeProtonGameConf', {
            targetProton: this.currentGeProton.name,
            gameId: this.geGameOptionValue,
            content: content,
          }).then((resp)=>{
            if(apiErrorAndReturn(this, resp)){
              return;
            }
            this.$message.success('设置成功');
          }).catch((e)=>{
            console.error(e);
            this.$message.error(e.message);
          })
        },

        updateGeProtonGameConf: function(json){
          for(const v in json){
            this.geGameOptionConf[v] = json[v];
          }
          this.writeGeProtonGameConfContent(this.geGameOptionConf);
          this.geGameOptionConf = JSON.parse(JSON.stringify(this.geGameOptionConf))
        },

        updateGeProtonAttachGame: function(){
            if(!this.currentGeProton.name){
                this.$message.warning('请先选择兼容层');
                return;
            }
            if(!this.currentGeProton.version){
                this.$message.warning('兼容层未打补丁');
                return;
            }
            if(this.currentGeProton.version === '1.0.0'){
                this.$message.warning('兼容层补丁版本太低，请重现打补丁');
                return;
            }
            commandRequest('GAME_SETTING', 'openFileSelector', {}).then((resp)=>{
            if(apiErrorAndReturn(this, resp)){
             // 不选择任何东西, 就清除设置
              this.$alert('取消游戏运行时启动附件应用', '是否取消', {
                confirmButtonText: '确定',
                callback: (action) => {
                    if (action === 'confirm') {
                        this.updateGeProtonGameConf({WINE_EXTRA_EXE:''});
                    }
                }
              });
              return;
            }
            let path = resp.data.data.result;
            path = path.indexOf('select file:') >= 0 ? path.split('select file:')[1] : '';
            console.log(`path:${path}`);
            if(new RegExp("[\\u4E00-\\u9FFF]+", "g").test(path) || path.indexOf(' ') >= 0){
                this.$message.warning('文件路径或文件名不能包含中文或空格!');
                return;
            }
            // 选择了目录
            if(path){
              this.geGameOptionConf['WINE_CHEATENGINE'] = 0;
              this.geGameOptionConf['WINE_FLINGTRAINER'] = 0;
              this.updateGeProtonGameConf({WINE_EXTRA_EXE:path, WINE_CHEATENGINE:'0', WINE_FLINGTRAINER:'0'});
            }
          }).catch((e)=>{
            console.error(e);
            this.$message.error(e.message);
          });
        },

        updateGeProtonTaskmgr: function(){
            if(!this.currentGeProton.name){
                this.$message.warning('请先选择兼容层');
                return;
            }
            if(!this.currentGeProton.version){
                this.$message.warning('兼容层未打补丁');
                return;
            }
            if(this.currentGeProton.version === '1.0.0'){
                this.$message.warning('兼容层补丁版本太低，请重现打补丁');
                return;
            }
          if(this.geGameOptionConf['WINE_TASKMGR'] == '0'){
              this.geGameOptionConf['WINE_TASKMGR'] = '1'
          }
          else {
              this.geGameOptionConf['WINE_TASKMGR'] = '0'
          }
          this.updateGeProtonGameConf({WINE_TASKMGR:this.geGameOptionConf['WINE_TASKMGR']});
        },


       updateGeProtonCheat: function(cheatTools){
          if(!this.currentGeProton.name){
              this.$message.warning('请先选择兼容层');
              return;
          }
          if(!this.currentGeProton.version){
              this.$message.warning('兼容层未打补丁');
              return;
          }
          if(this.currentGeProton.version === '1.0.0'){
              this.$message.warning('兼容层补丁版本太低，请重现打补丁');
              return;
          }
          const cheatAppPath = (cheatTools == 'CheatEngine') ?  `${this.appSetting.user_home_path}/${STEAM_CONST.APP_WINDOWS_APP_PATH}/CheatEngine/CheatEngine.exe` :
              `${this.appSetting.user_home_path}/${STEAM_CONST.APP_WINDOWS_APP_PATH}/FLiNGTrainer/FLiNGTrainer.exe`;
           commandRequest('GAME_SETTING', 'ioCtl', {
               ctl: 'file_exist',
               src: cheatAppPath
           }).then((resp)=>{
               if(apiErrorAndReturn(this, resp)){
                   return;
               }
               let exist = resp.data.data.result || false;
               if(!exist){
                   this.$alert(`没有安装该软件, 请到"软件中心"->"windows软件"下载`);
                   return;
               }
               // 设置开启或关闭
               if(cheatTools == 'CheatEngine'){
                   this.geGameOptionConf['WINE_CHEATENGINE'] = (this.geGameOptionConf['WINE_CHEATENGINE'] == '0') ? '1' : '0';
                   if(this.geGameOptionConf['WINE_CHEATENGINE'] == '1'){
                       this.geGameOptionConf['WINE_FLINGTRAINER'] = 0;
                       this.geGameOptionConf['WINE_EXTRA_EXE'] = cheatAppPath;
                   }
                   this.updateGeProtonGameConf({WINE_CHEATENGINE:this.geGameOptionConf['WINE_CHEATENGINE'], WINE_FLINGTRAINER:this.geGameOptionConf['WINE_FLINGTRAINER'], WINE_EXTRA_EXE:this.geGameOptionConf['WINE_EXTRA_EXE']});
               }
               else {
                   this.geGameOptionConf['WINE_FLINGTRAINER'] = (this.geGameOptionConf['WINE_FLINGTRAINER'] == '0') ? '1' : '0';
                   if(this.geGameOptionConf['WINE_FLINGTRAINER'] == '1'){
                       this.geGameOptionConf['WINE_CHEATENGINE'] = 0;
                       this.geGameOptionConf['WINE_EXTRA_EXE'] = cheatAppPath;
                   }
                   this.updateGeProtonGameConf({WINE_CHEATENGINE:this.geGameOptionConf['WINE_CHEATENGINE'], WINE_FLINGTRAINER:this.geGameOptionConf['WINE_FLINGTRAINER'], WINE_EXTRA_EXE:this.geGameOptionConf['WINE_EXTRA_EXE']});
               }
           }).catch((e)=>{
               console.error(e);
               this.$message.error(e.message);
           });
       },
        onChangeGeProtonGame:function() {
          this.readGeProtonGameConf();
        },
        onSystemToolsDownload(index, row){
            window.open(row.url);
        },
        onSystemToolsShowPath(index, row){
            this.onOpenTargetPath(STEAM_CONST.STEAM_COMPAT_TOOL_PATH);
        },
        onArchiveInstallFromDownloadPath(index, row, systemTools){
            const softwarePath = `${this.appSetting.user_home_path}/Downloads`;
            commandRequest('GAME_SETTING', 'ioCtl', {
                ctl: 'list',
                src: softwarePath
            }).then((resp)=>{
                if(apiErrorAndReturn(this, resp)){
                    return;
                }
                let fileList = resp.data.data.result || [];
                console.log(`fileList: ${JSON.stringify(fileList)}`)
                fileList = fileList.filter(v=>v.indexOf(row.key) >= 0); // 利用key搜索
                fileList = fileList.filter(v=>{
                    return ARCHIVE_FILE_SUFFIX.some(vv=>v.endsWith(vv));// 后缀名要满足
                });
                // Proton兼容层暂只支持tar类型压缩包, 去除zip包后缀
                if(systemTools === 1){
                    fileList = fileList.filter(v=>!v.endsWith(".zip"));
                }
                if(fileList.length === 0){
                    this.$alert(row.name + " 不在用户下载目录(Downloads)下");
                    return;
                }
                this.softwareDialogOptions = fileList.map(v=>{
                    return {
                        value: v.toString(),
                        label: v.toString(),
                    }
                });
                this.softwareInfo = JSON.parse(JSON.stringify(row));
                this.softwareInfo.systemTools = systemTools || 0; // 系统工具
                // 找到了文件, 弹选择框安装
                this.softwareDialogVisible = true;
                this.softwareDialogOptionsValue = this.softwareDialogOptions[0]; // 默认选中第一个(不生效)
            }).catch((e)=>{
                console.error(e);
                this.$message.error(e.message);
            })
        },
        onSoftwareDownload(index, row){
          window.open(row.url);
        },
        onSoftwareShowPath(index, row){
          this.onOpenTargetPath(`${this.appSetting.user_home_path}/${STEAM_CONST.APP_WINDOWS_APP_PATH}`);
        },
        onConfirmInstallSoftware(){
            this.softwareInfo.fileSelected = this.softwareDialogOptionsValue;
            const isProton =  /GE-Proton[\d]+-[\d]+/g.test(this.softwareInfo.name) && this.softwareInfo.systemTools === 1;
            if(isProton){
                this.onConfirmInstallProton(isProton);
                this.softwareDialogVisible = false;
                return;
            }
            // 普通的小软件安装
            let dstPath = `${this.appSetting.user_home_path}/${STEAM_CONST.APP_WINDOWS_APP_PATH}`;
            const srcPath = `${this.appSetting.user_home_path}/Downloads/${this.softwareInfo.fileSelected}`;
            // 是否已安装相同版本的软件?
            commandRequest('GAME_SETTING', 'ioCtl', {
                ctl: 'file_exist',
                src: `${dstPath}/${this.softwareInfo.name}`
            }).then((resp)=>{
                if(apiErrorAndReturn(this, resp)){
                    return;
                }
                let exist = resp.data.data.result || false;
                if(exist){
                    this.$alert(`目录:${dstPath}已安装了该软件`);
                    return;
                }
                // 解压压缩包方式安装(阻塞安装)
                const loading = this.$loading({
                    lock: true,
                    text: '安装中',
                    spinner: 'el-icon-loading',
                    background: 'rgba(0, 0, 0, 0.7)'
                });
                commandRequest('GAME_SETTING', 'ioCtl', {
                    ctl: 'decompress_to',
                    src: srcPath,
                    dst: dstPath,
                }).then((resp)=>{
                    loading.close();
                    if(apiErrorAndReturn(this, resp)){
                        return;
                    }
                    this.$alert(`安装软件${this.softwareInfo.name}到${dstPath}成功`);
                }).catch((e)=>{
                    loading.close();
                    console.error(e);
                    this.$message.error(e.message);
                })
            }).catch((e)=>{
                console.error(e);
                this.$message.error(e.message);
            });
            this.softwareDialogVisible = false;
        },
        onConfirmInstallProton(){
            let dstPath = `${this.appSetting.user_home_path}/${STEAM_CONST.STEAM_COMPAT_TOOL_PATH}`;
            const srcPath = `${this.appSetting.user_home_path}/Downloads/${this.softwareInfo.fileSelected}`;
            // 是否已安装相同版本的软件?
            commandRequest('GAME_SETTING', 'ioCtl', {
                ctl: 'file_exist',
                src: `${dstPath}/${this.softwareInfo.name}`
            }).then((resp)=>{
                if(apiErrorAndReturn(this, resp)){
                    return;
                }
                let exist = resp.data.data.result || false;
                if(exist){
                    this.$alert(`目录:${dstPath}已安装了该软件`);
                    return;
                }
                const loading = this.$loading({
                    lock: true,
                    text: '安装中',
                    spinner: 'el-icon-loading',
                    background: 'rgba(0, 0, 0, 0.7)'
                });
                // 解压压缩包方式安装(使用同步任务)
                commandRequest('GAME_SETTING', 'untar_huge_file', {
                    src: srcPath,
                    dst: dstPath,
                }).then((resp)=>{
                    loading.close();
                    if(apiErrorAndReturn(this, resp)){
                        return;
                    }
                    this.$alert(`安装兼容层${this.softwareInfo.name}到${dstPath}成功`);
                }).catch((e)=>{
                    loading.close();
                    console.error(e);
                    this.$message.error(e.message);
                })
            }).catch((e)=>{
                console.error(e);
                this.$message.error(e.message);
            });
        },
        onSystemToolsInstall(index, row){
          this.onConfirmInstallSystemToolsScript(row, (installed)=>{
              if(installed){
                  this.$message.success("该工具已安装");
                  return;
              }
              // 启动安装脚本
              commandRequest('GAME_SETTING', 'runLocalScriptWithTerminal', {
                  script_file: row.key,
                  need_sudo: 1,
              }).then((resp)=>{
                  if(apiErrorAndReturn(this, resp)){
                      // 没有设置deck密码
                      if(resp.data.code == 10){
                          setTimeout(()=>{
                              this.$message.success("请先设置【deck用户密码】，并牢记你的密码");
                              commandRequest('GAME_SETTING', 'runLocalScriptWithTerminal', {
                                  script_file: 'passwd_new_set.sh',
                                  need_sudo: 0,
                              }).then((resp)=>{
                                  if(apiErrorAndReturn(this, resp)){
                                      return;
                                  }
                                  this.$message.success("密码设置成功");
                              }).catch((e)=>{
                              });
                          }, 2000);
                      }
                      return;
                  }
                  const result = resp.data.data.result;
                  this.$message.success("安装成功");
              }).catch((e)=>{
                  console.error(e);
              });
          })
        },
        // 显示一个软件简要信息(运行状态，附加信息)的对话框
        onSystemToolsStatus(index, row){
            let content = '';
            if(row.key === 'system_font_installer.sh'){

            }
            if(row.key === 'sshd_installer.sh'){

            }
            this.$alert('<strong>这是 <i>HTML</i> 片段</strong>', '软件状态', {
                dangerouslyUseHTMLString: true
            });
        },
        // 判断系统是否已安装对应linux脚本
        onConfirmInstallSystemToolsScript(tools, cbFunc){
            if(!tools.test_command || !tools.test_installed_condition){
                console.error("test_command or test_installed_condition not defined!");
                return false
            }
            commandRequest('GAME_SETTING', 'runShellCommand', {
                command: tools.test_command
            }).then((resp)=>{
                if(apiErrorAndReturn(this, resp)){
                    return;
                }
                const result = resp.data.data.result;
                let installed = false;
                if(tools.test_installed_condition == 'GT_ZERO'){
                    if(parseInt(result.trim()) > 0){
                        installed = true
                    }
                }
                if(typeof cbFunc ==='function'){
                    cbFunc(installed)
                }
            }).catch((e)=>{
                console.error(e);
            });
        },


        onChangeWindows:function () {
          if(this.main_windows === '1'){
            commandRequest('GAME_SETTING', 'gameList', {}).then((resp)=>{
              if(apiErrorAndReturn(this, resp)){
                return;
              }
              const result = resp.data.data.result;
              const pattg = /.* \([\d]{2,}\)/g;
              let gameList = result.match(pattg) || [];
              gameList = gameList.map(v=>{
                const id = v.substring(v.indexOf('(')+1, v.indexOf(')'));
                return {
                  id: id,
                  name: v.substring(0, v.indexOf('(')).replace('Non-Steam shortcut:', ''),
                  nonSteam: v.indexOf('Non-Steam shortcut') >=0 ? 1 : 0,
                  diskC_Path: '.local/share/Steam/steamapps/compatdata/' + id + '/pfx/drive_c',
                }
              });
              this.gameList = gameList;
            }).catch((e)=>{
              console.error(e);
              this.$message.error(e.message);
            })
          }
          else if(this.main_windows === '2'){
            this.geGameOptionValue = '';
            commandRequest('PROTON_PATCH', 'geProtonList', {}).then((resp)=>{
              if(apiErrorAndReturn(this, resp)){
                return;
              }
              const result = resp.data.data.result;
              const pattg = /GE-Proton[\d]+-[\d]+/g;
              let geProtonList = result.match(pattg) || [];
              geProtonList = geProtonList.map(v=>{
                return {
                  name: v
                }
              });
              this.geProtonList = geProtonList;

              this.geGameOptions = this.gameList.map(v=>{
                return {
                  value:v.id,
                  label:`${v.name}(${v.id})`,
                }
              });
              if(geProtonList.length === 0){
                this.$alert(`检测到没有安装GE-Proton兼容层, 请到"软件中心"->"系统工具"下载`);
              }
            }).catch((e)=>{
              console.error(e);
              this.$message.error(e.message);
            })
          }

        }
      },

      mounted: function () {
        this.onChangeWindows();
        // 先检查protontricks是否已安装
        commandRequest('GAME_SETTING', 'checkProtontricksInstalled', {}).then((resp)=>{
          if(apiErrorAndReturn(this, resp)){
            return;
          }

          this.checkAppOnlineVersion();
        }).catch((e)=>{
          console.error(e);
          this.$message.error(e.message);
        });

        // 轮询异步任务的请求结果
        fetch_async_task_ticker = setInterval(()=>{
            commandRequest('GAME_SETTING', 'fetch_async_task_result', {}).then((resp)=>{
                if(apiErrorAndReturn(this, resp)){
                    return;
                }
                if(resp.data.data && resp.data.data.length > 0){
                    this.onHandlerAsyncTaskError(resp.data.data);
                }
            }).catch((e)=>{
                console.error(e);
                this.$message.error(e.message);
            });

        }, 30000);
        this.onGetAppSetting();
      },
      created: function() {
          window.onload = function () {
              window.onbeforeunload = function () {
                  clearInterval(fetch_async_task_ticker);
                  // 关闭python应用
                  axios({
                      method: 'get',
                      url: '/app/exit'
                  }).then(resp=>{
                      this.$alert('程序已关闭', '提示', {
                          confirmButtonText: '确定',
                      });
                  });
                  return "Do you really want to close?";
              };
          }
      }
    })
  </script>
</html>